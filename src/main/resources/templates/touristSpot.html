<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${touristSpot.title}">관광지 예시</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#fff; color:#333; }
    header { display:flex; justify-content:space-between; align-items:center; padding:15px 30px; border-bottom:1px solid #ddd; }
    header h1 { font-size:24px; cursor:pointer; }
    .user-info { display:flex; align-items:center; gap:8px; }
    .user-info a { font-weight:bold; }
    .hotel-info { display:flex; padding:20px 30px; gap:20px; }
    .hotel-image { width:300px; height:200px; object-fit:cover; background:#f0f0f0; }
    .hotel-details { flex:1; }
    .hotel-details h2 { margin:0 0 10px; display:flex; align-items:center; gap:10px; }
    .favorite-btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#ff4757; color:#fff; font-weight:bold; }
    .favorite-btn.active { background:#2ed573; }
    nav { display:flex; gap:30px; padding:10px 30px; border-top:1px solid #ddd; border-bottom:1px solid #ddd; background:#fafafa; cursor:pointer; }
    .info-section, .facility-section, .review-section { padding:20px 30px; display:none; }
    .btn { background:#333; color:#fff; padding:8px 16px; border:none; cursor:pointer; margin-right:8px; border-radius:4px; }
    .btn.active { background:#007bff; }
    .reviews { display:flex; flex-direction:column; gap:20px; }
    .review { border:1px solid #ddd; padding:15px; border-radius:8px; background:#fafafa; position:relative; }
    .review button { font-size:12px; padding:4px 8px; margin-left:4px; }
    .map-container { width:100%; height:500px; margin-top:16px; border-radius:12px; border:1px solid #eee; box-shadow:0 1px 2px rgba(0,0,0,.03); background:#fafafa; }
    nav span.active { font-weight:bold; text-decoration:underline; color:#000; }
    .filter-buttons { margin-bottom:12px; }
    .review-form textarea { width:100%; height:80px; padding:8px; margin-bottom:10px; }
  </style>
</head>
<body>

<header>
  <h1 th:onclick="|window.location='@{/}'|">Tour</h1>
  <div class="user-info">
        <span th:if="${#authentication.authenticated}">
            <a th:href="@{/user/myPage}" style="text-decoration:none; color:inherit;" th:text="${#authentication.name}">사용자</a>
        </span>
    <form th:if="${#authentication.authenticated}" th:action="@{/logout}" method="post" style="display:inline;">
      <button type="submit" class="btn">로그아웃</button>
    </form>
    <a th:if="${!#authentication.authenticated}" th:href="@{/login}" class="btn">로그인</a>
  </div>
</header>

<!-- 현재 로그인 username hidden -->
<input type="hidden" id="currentUser" th:value="${#authentication.name}">

<section class="hotel-info">
  <img th:src="${touristSpot.firstimage}" alt="관광지 이미지" class="hotel-image">
  <div class="hotel-details">
    <h2>
      <span th:text="${touristSpot.title}"></span>
      <button id="favoriteBtn" class="favorite-btn"
              th:data-id="${touristSpot.id}"
              th:data-type="'touristSpot'"
              th:text="${isFavorite} ? '♥ 즐겨찾기됨' : '♡ 즐겨찾기'"></button>
    </h2>
  </div>
</section>

<input type="hidden" id="accommodationId" th:value="${touristSpot.id}">
<input type="hidden" id="isFavorite" th:value="${isFavorite}">

<nav>
  <span data-target="info">주요 정보</span>
  <span data-target="facility">시설&서비스</span>
  <span data-target="review">리뷰</span>
</nav>

<section class="info-section">
  <h3>주요 정보</h3>
  <p><strong>주소:</strong> <span th:text="${touristSpot.addr1} + ' ' + ${touristSpot.addr2}"></span></p>
  <p><strong>전화번호:</strong> <span th:text="${touristSpot.tel}"></span></p>
  <p><strong>지도 좌표:</strong> (<span id="mapx" th:text="${touristSpot.mapx}"></span>, <span id="mapy" th:text="${touristSpot.mapy}"></span>)</p>
  <div id="map-info" class="map-container"></div>
</section>

<section class="facility-section">
  <h3>시설 & 서비스</h3>
  <div class="filter-buttons">
    <button class="btn active" data-category="all">전체</button>
    <button class="btn" data-category="accommodation">숙소</button>
    <button class="btn" data-category="leports">레포츠</button>
    <button class="btn" data-category="restaurant">식당</button>
    <button class="btn" data-category="shopping">쇼핑</button>
    <button class="btn" data-category="touristSpot">관광지</button>
  </div>
  <div id="map-facility" class="map-container"></div>
</section>

<section class="review-section">
  <h3>리뷰</h3>

  <form id="reviewForm" class="review-form">
    <textarea name="content" placeholder="리뷰를 작성해주세요..." required></textarea>
    <button type="submit" class="btn">작성하기</button>
  </form>

  <div class="reviews" id="reviewsContainer"></div>
</section>

<script>
  const currentUser = document.getElementById('currentUser').value;

  const tabs = document.querySelectorAll('nav span');
  const sections = {
      info: document.querySelector('.info-section'),
      facility: document.querySelector('.facility-section'),
      review: document.querySelector('.review-section')
  };
  function hideAllSections(){ Object.values(sections).forEach(sec => sec.style.display='none'); }
  tabs.forEach(tab => tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      hideAllSections();
      const target = tab.getAttribute('data-target');
      sections[target].style.display = 'block';
      if(target==='info') initMap('map-info');
      if(target==='facility') loadNearbyFacilities('all');
      if(target==='review') loadReviews();
  }));
  tabs[0].click();

  const KAKAO_JS_KEY = "c1a0fc126750fc75623bdc1df69dfb93";
  (function loadKakaoSDK(){
      const s=document.createElement("script");
      s.src="https://dapi.kakao.com/v2/maps/sdk.js?appkey="+encodeURIComponent(KAKAO_JS_KEY)+"&autoload=false";
      s.defer=true;
      s.onload=()=>{ if(window.kakao&&kakao.maps&&kakao.maps.load){ kakao.maps.load(()=>{ initMap('map-info'); }); } };
      document.head.appendChild(s);
  })();

  function initMap(containerId){
      const mapX=parseFloat(document.getElementById("mapx").innerText);
      const mapY=parseFloat(document.getElementById("mapy").innerText);
      const container=document.getElementById(containerId); if(!container)return;
      const center=new kakao.maps.LatLng(mapY,mapX);
      const map=new kakao.maps.Map(container,{center,level:6});
      new kakao.maps.Marker({position:center,map});
  }

  let markers=[];
  function loadNearbyFacilities(filterCategory){
      const accId=document.getElementById("accommodationId").value;
      const mapX=parseFloat(document.getElementById("mapx").innerText);
      const mapY=parseFloat(document.getElementById("mapy").innerText);
      const container=document.getElementById('map-facility'); if(!container)return;
      const center=new kakao.maps.LatLng(mapY,mapX);
      const map=new kakao.maps.Map(container,{center,level:6});
      new kakao.maps.Marker({position:center,map});
      markers.forEach(m=>m.setMap(null)); markers=[];
      fetch(`/touristSpot/${accId}/nearby`)
      .then(res=>res.json())
      .then(data=>{
          const categories=['accommodation','leports','restaurant','shopping','touristSpot'];
          categories.forEach(category=>{
              if(filterCategory!=='all'&&category!==filterCategory) return;
              data[category]?.forEach(item=>{
                  if(!item.mapx||!item.mapy) return;
                  const marker=new kakao.maps.Marker({position:new kakao.maps.LatLng(item.mapy,item.mapx),map,title:item.title});
                  kakao.maps.event.addListener(marker,'click',()=>{ window.location.href=`/${category}/view/${item.id}`; });
                  markers.push(marker);
              });
          });
      }).catch(err=>console.error(err));
  }

  document.querySelectorAll('.filter-buttons .btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
          document.querySelectorAll('.filter-buttons .btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          loadNearbyFacilities(btn.getAttribute('data-category'));
      });
  });

  // ================= 리뷰 AJAX =================
  const reviewForm = document.getElementById("reviewForm");
  const reviewsContainer = document.getElementById("reviewsContainer");
  const accId = document.getElementById("accommodationId").value;

  function addReviewToDOM(review){
      const div=document.createElement('div');
      div.className='review';
      div.dataset.reviewId=review.id;
      div.innerHTML=`
          <h4>${review.nickname}</h4>
          <small>${new Date(review.createdAt).toLocaleDateString()}</small>
          <p>${review.content}</p>
          <div>
              ${review.username === currentUser
                  ? '<button class="edit-btn">수정</button><button class="delete-btn">삭제</button>'
                  : ''}
          </div>`;
      reviewsContainer.prepend(div);
  }

  async function loadReviews(){
      try{
          const res = await fetch(`/touristSpot/${accId}/review`);
          if(res.ok){
              const data = await res.json();
              reviewsContainer.innerHTML = '';
              data.forEach(addReviewToDOM);
          }
      }catch(err){ console.error(err); }
  }

  reviewForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const content=e.target.content.value;
      const res=await fetch(`/touristSpot/${accId}/review`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({content})
      });
      if(res.ok){
          const review=await res.json();
          addReviewToDOM(review);
          e.target.reset();
      }
  });

  reviewsContainer.addEventListener('click', async e=>{
      const reviewDiv=e.target.closest('.review');
      if(!reviewDiv) return;
      const reviewId=reviewDiv.dataset.reviewId;

      if(e.target.classList.contains('delete-btn')){
          if(await fetch(`/touristSpot/${accId}/review/${reviewId}`, {method:'DELETE'}).then(r=>r.ok)){
              reviewDiv.remove();
          }
      }

      if(e.target.classList.contains('edit-btn')){
          const newContent=prompt('리뷰를 수정하세요:', reviewDiv.querySelector('p').innerText);
          if(newContent){
              if(await fetch(`/touristSpot/${accId}/review/${reviewId}`, {
                  method:'PUT',
                  headers:{'Content-Type':'application/json'},
                  body:JSON.stringify({content:newContent})
              }).then(r=>r.ok)){
                  reviewDiv.querySelector('p').innerText=newContent;
              }
          }
      }
  });

  // ================= 즐겨찾기 버튼 =================
  const favoriteBtn = document.getElementById("favoriteBtn");
  favoriteBtn.addEventListener('click', async ()=>{
      const id = favoriteBtn.getAttribute('data-id');
      const type = favoriteBtn.getAttribute('data-type');
      const isActive = favoriteBtn.classList.contains('active');
      const url = `/user/favorites/${id}?type=${type}`;
      if(isActive){
          const res = await fetch(url, {method:'DELETE'});
          if(res.ok){
              favoriteBtn.classList.remove('active');
              favoriteBtn.textContent = '♡ 즐겨찾기';
          }
      } else {
          const res = await fetch(url, {method:'POST'});
          if(res.ok){
              favoriteBtn.classList.add('active');
              favoriteBtn.textContent = '♥ 즐겨찾기됨';
          }
      }
  });
</script>

</body>
</html>
