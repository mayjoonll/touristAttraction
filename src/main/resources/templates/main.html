<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour 메인 페이지</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 모든 요소에 box-sizing: border-box 적용 */
        * {
            box-sizing: border-box;
        }

        a{
            color: #333;
            text-decoration: none;
        }

        /* 기본적인 페이지 스타일 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: #f7f7f7;
            color: #333;
            margin: 0;
            padding-top: 60px; /* 고정된 헤더 높이만큼 패딩 추가 */
            overflow-x: hidden;
        }

        /* 컨텐츠 최대 너비 설정 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* 메인 배너 및 검색 영역 */
        .hero-section {
            background-color: #d9d9d9;
            padding: 80px 0;
            text-align: left;
            margin-bottom: 40px;
        }

        .hero-section h1 {
            font-size: 40px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: left;
        }

        .search-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 0 auto;
        }

        /* 검색 섹션 컨테이너 너비를 1200px로 고정 */
        .hero-section .container {
            max-width: 1200px;
        }

        .search-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-tabs button {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-tabs button:hover,
        .search-tabs button.active {
            background-color: #f0f0f0;
            border-color: #999;
        }

        /* 검색 영역과 버튼 분리 */
        .search-group {
            display: flex;
            gap: 12px;
            position: relative;
            flex-direction: column; /* 버튼 그룹과 검색창 수직 정렬 */
        }

        .search-group form{
            display: flex;
            gap: 16px;
        }

        /* 검색 버튼 그룹 스타일 */
        .search-options {
            display: flex;
            gap: 10px;
        }

        /* 드롭다운 버튼을 감싸는 컨테이너 */
        .dropdown-wrapper {
            position: relative;
        }

        .search-option-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 8px 15px; /* 세로 패딩 줄여서 버튼 높이 조정 */
            border: 1px solid #e0e0e0;
            background-color: #fff;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            color: #555;
            width: fit-content;
        }

        .search-option-button i {
            font-size: 16px;
        }

        .search-input-and-button {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .search-input-wrapper {
            box-sizing: border-box;
            flex-grow: 1;
            position: relative;
        }

        .search-input-wrapper input {
            box-sizing: border-box;
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            font-size: 16px;
            outline: none;
        }

        .search-button {
            background-color: #999;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            width: fit-content;
            white-space: nowrap;
        }

        /* 추천/최근 검색어 드롭다운 */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-top: 5px;
            z-index: 5;
            padding: 10px;
            display: none;
        }

        .search-dropdown-inner {
            max-height: 200px; /* 드롭다운 메뉴 스크롤 가능하도록 */
            overflow-y: auto;
        }

        .search-dropdown-item {
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
        }

        .search-dropdown-item:hover {
            background-color: #f0f0f0;
        }

        .search-dropdown-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        /* 섹션 공통 스타일 */
        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .carousel-wrapper {
            position: relative;
        }

        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 10;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 인기 여행지 화살표 위치 수정 */
        .popular-attractions-section .carousel-button {
            top: 75px; /* 이미지 높이(150px)의 절반 위치 */
            transform: translateY(-50%);
        }

        .carousel-button.left {
            left: -20px;
        }

        .carousel-button.right {
            right: -20px;
        }

        /* 비활성화 버튼 스타일 */
        .carousel-button:disabled {
            background-color: rgba(230, 230, 230, 0.8);
            border-color: #e0e0e0;
            color: #aaa;
            cursor: not-allowed;
        }

        .card-list {
            display: flex;
            gap: 20px;
            overflow-x: scroll;
            padding-bottom: 20px;
            scrollbar-width: none;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .card-list::-webkit-scrollbar {
            display: none;
        }

        /* 카드 없을 때 문구 스타일 */
        .no-results-message {
            width: 100%;
            text-align: center;
            color: #777;
            font-size: 18px;
            margin-top: 50px;
            margin-bottom: 50px;
        }

        /* 인기 여행지 카드 스타일 */
        .card {
            min-width: 150px;
            flex-shrink: 0;
            text-align: left;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-placeholder {
            width: 100%;
            height: 150px;
            background-color: #e9e9e9;
            border-radius: 5px;
            margin-bottom: 10px;
            position: relative;
        }

        .card-title {
            font-size: 16px;
            color: #555;
        }

        /* 모든 별점 색상 통일 */
        .rating {
            color: #888;
        }

        /* 이벤트 카드 스타일 */
        .events-section .search-tabs {
            margin-bottom: 20px;
        }

        .event-card {
            min-width: 350px;
            flex-shrink: 0;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .event-card:hover {
            transform: translateY(-2px);
        }

        .event-card-placeholder {
            width: 100%;
            height: 200px;
            background-color: #e9e9e9;
        }

        .event-details {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .event-details p {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #777;
        }

        .event-details h3 {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #333;
        }

        .event-details .price-box {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-top: 15px;
        }

        .event-details .original-price {
            font-size: 12px;
            color: #999;
            text-decoration: line-through;
            margin-bottom: 2px;
        }

        .event-details .final-price {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
    </style>
    <th:block th:insert="~{fragments/header :: styles}"></th:block>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<main>
    <section class="hero-section">
        <div class="container">
            <h1 class="tour-attraction">Tour Attraction</h1>
            <div class="search-container">
                <div class="search-group">
                    <form th:action="@{/kakaoResult4}" method="GET">
                        <div class="search-input-wrapper">
                            <input type="text"
                                   name="keyword"
                                   placeholder="여행지 또는 지역을 검색해보세요."
                                   th:value="${param.keyword}">
                        </div>
                        <button class="search-button" type="submit">검색</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <div class="container">
        <section class="popular-attractions-section" style="position: relative; margin-bottom: 40px;">
            <h2 class="section-title">인기 여행지</h2>
            <div class="carousel-wrapper">
                <button id="popular-left-btn" class="carousel-button left" onclick="scrollCarousel('popular', -1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="popular-carousel" class="card-list">
                    <div class="card" data-type="관광지" data-region="제주도">
                        <div class="card-placeholder"></div>
                        <div class="card-title">성산일출봉</div>
                    </div>
                </div>
                <button id="popular-right-btn" class="carousel-button right" onclick="scrollCarousel('popular', 1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div id="popular-no-results" class="no-results-message" style="display: none;">
                    해당 지역 및 종류의 여행 상품이 준비 중입니다.
                </div>
            </div>
        </section>

        <section class="events-section" style="position: relative; margin-bottom: 40px;">
            <h2 class="section-title">Event</h2>
            <div class="search-tabs">
                <button data-filter="all" class="active">전체</button>
                <button data-filter="숙박">숙박</button>
                <button data-filter="레포츠">레포츠</button>
                <button data-filter="관광지">관광지</button>
                <button data-filter="쇼핑">쇼핑</button>
                <button data-filter="음식점">음식점</button>
            </div>
            <div class="carousel-wrapper">
                <button id="event-left-btn" class="carousel-button left" onclick="scrollCarousel('event', -1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="event-carousel" class="card-list">
                    <div class="event-card" data-type="숙박" data-region="제주도">
                        <div class="event-card-placeholder"></div>
                        <div class="event-details">
                            <div>
                                <p>숙박 호텔</p>
                                <h3>Hotel Example</h3>
                                <p>제주시</p>
                                <p class="rating">별점 ★★★</p>
                            </div>
                            <div class="price-box">
                                <span class="original-price">200,000원</span>
                                <span class="final-price">83,700원</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="event-right-btn" class="carousel-button right" onclick="scrollCarousel('event', 1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div id="event-no-results" class="no-results-message" style="display: none;">
                    해당 지역 및 종류의 여행 상품이 준비 중입니다.
                </div>
            </div>
        </section>
    </div>
</main>

<script>
    // --- 전역 변수 설정 ---
    let datePickerBtn = document.getElementById('date-picker-btn');
    let datePickerDropdown = document.getElementById('date-picker-dropdown');
    let dateTextSpan = document.getElementById('date-text');
    let peoplePickerBtn = document.getElementById('people-picker-btn');
    let peoplePickerDropdown = document.getElementById('people-picker-dropdown');
    let peopleTextSpan = document.getElementById('people-text');
    let peopleOptionBtns = document.querySelectorAll('#people-picker-dropdown .people-options button');
    let peopleInput = document.getElementById('people-input');
    let searchInput = document.getElementById('search-input');
    let searchDropdown = document.getElementById('search-dropdown');
    let popularCarousel = document.getElementById('popular-carousel');
    let eventCarousel = document.getElementById('event-carousel');
    let popularNoResults = document.getElementById('popular-no-results');
    let eventNoResults = document.getElementById('event-no-results');

    // 햄버거 메뉴 관련 변수 추가
    const hamburgerBtn = document.getElementById('hamburger-menu');
    const hamburgerDropdown = document.getElementById('hamburger-dropdown');

    // 캐러셀 관련 변수
    const popularCards = document.querySelectorAll('#popular-carousel .card');
    const eventCards = document.querySelectorAll('#event-carousel .event-card');

    // 달력 관련 변수
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn2 = document.getElementById('next-month-btn-2');

    let currentDate = new Date();
    let startDate = null;
    let endDate = null;
    let holidays = {};

    const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];

    // --- 기능 함수 ---
    // 공휴일 데이터 불러오기
    async function fetchHolidays(year) {
        try {
            // 간단한 공휴일 데이터 (실제로는 API에서 가져올 수 있음)
            holidays = {};
            renderCalendars();
        } catch (error) {
            console.error('공휴일 데이터 로드 실패:', error);
        }
    }

    function isHoliday(date) {
        const dateStr = date.toISOString().split('T')[0];
        return holidays[dateStr] || '';
    }

    // 날짜 텍스트 업데이트
    function updateDateText() {
        if (startDate && endDate) {
            const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const nights = diffDays > 0 ? diffDays : 0;

            const startMonth = (startDate.getMonth() + 1).toString().padStart(2, '0');
            const startDay = startDate.getDate().toString().padStart(2, '0');
            const startDayName = daysOfWeek[startDate.getDay()];

            const endMonth = (endDate.getMonth() + 1).toString().padStart(2, '0');
            const endDay = endDate.getDate().toString().padStart(2, '0');
            const endDayName = daysOfWeek[endDate.getDay()];

            dateTextSpan.textContent = `${startMonth}.${startDay} ${startDayName} - ${endMonth}.${endDay} ${endDayName} (${nights}박)`;
        } else if (startDate) {
            const startMonth = (startDate.getMonth() + 1).toString().padStart(2, '0');
            const startDay = startDate.getDate().toString().padStart(2, '0');
            const startDayName = daysOfWeek[startDate.getDay()];
            dateTextSpan.textContent = `${startMonth}.${startDay} ${startDayName}`;
        } else {
            dateTextSpan.textContent = '날짜';
        }
    }

    // 달력 그리기
    function renderMonth(monthOffset, calendarGridId, calendarTitleId) {
        const monthDate = new Date(currentDate);
        monthDate.setMonth(currentDate.getMonth() + monthOffset);

        const calendarGrid = document.getElementById(calendarGridId);
        const calendarTitle = document.getElementById(calendarTitleId);

        calendarGrid.innerHTML = '';

        daysOfWeek.forEach(day => {
            const header = document.createElement('div');
            header.className = 'day-header';
            header.textContent = day;
            if (day === '일') header.style.color = 'red';
            else if (day === '토') header.style.color = 'blue';
            calendarGrid.appendChild(header);
        });

        const year = monthDate.getFullYear();
        const month = monthDate.getMonth();
        calendarTitle.textContent = `${year}년 ${month + 1}월`;

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyDay = document.createElement('div');
            calendarGrid.appendChild(emptyDay);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = i;

            const dayDate = new Date(year, month, i);
            dayDate.setHours(0, 0, 0, 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (dayDate < today) {
                dayDiv.classList.add('inactive');
            } else {
                dayDiv.dataset.date = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                dayDiv.addEventListener('click', handleDateClick);
            }

            if (dayDate.getDay() === 0) {
                dayDiv.classList.add('sunday');
            } else if (dayDate.getDay() === 6) {
                dayDiv.classList.add('saturday');
            }

            const holidayName = isHoliday(dayDate);
            if (holidayName) {
                dayDiv.classList.add('holiday');
                dayDiv.title = holidayName;
            }

            if (startDate && dayDate.getTime() === startDate.getTime()) {
                dayDiv.classList.add('start-date');
            }
            if (endDate && dayDate.getTime() === endDate.getTime()) {
                dayDiv.classList.add('end-date');
            }
            if (startDate && endDate && dayDate > startDate && dayDate < endDate) {
                dayDiv.classList.add('in-range');
            }

            calendarGrid.appendChild(dayDiv);
        }
    }

    function renderCalendars() {
        renderMonth(0, 'calendar-grid-1', 'calendar-title-1');
        renderMonth(1, 'calendar-grid-2', 'calendar-title-2');

        const today = new Date();
        prevMonthBtn.style.visibility = (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() === today.getMonth()) ? 'hidden' : 'visible';
    }

    // 날짜 선택 이벤트 핸들러
    function handleDateClick(e) {
        e.stopPropagation();

        if (e.target.classList.contains('inactive')) {
            return;
        }

        const [year, month, day] = e.target.dataset.date.split('-').map(Number);
        const selectedDate = new Date(year, month - 1, day);
        selectedDate.setHours(0, 0, 0, 0);

        if (!startDate || (startDate && endDate)) {
            startDate = selectedDate;
            endDate = null;
        } else {
            if (selectedDate.getTime() < startDate.getTime()) {
                endDate = startDate;
                startDate = selectedDate;
            } else {
                endDate = selectedDate;
            }
            updateDateText();
            datePickerDropdown.style.display = 'none';
        }
        renderCalendars();
    }

    // 캐러셀 스크롤 함수
    function scrollCarousel(id, direction) {
        const carousel = document.getElementById(id + '-carousel');
        const scrollAmount = carousel.clientWidth;
        carousel.scrollBy({
            left: scrollAmount * direction,
            behavior: 'smooth'
        });
    }

    // 화살표 버튼 활성화/비활성화 및 드래그 스크롤링 관리
    function setupCarousel(id) {
        const carousel = document.getElementById(id + '-carousel');
        const leftBtn = document.getElementById(id + '-left-btn');
        const rightBtn = document.getElementById(id + '-right-btn');
        const noResultsMsg = document.getElementById(id + '-no-results');

        if (!carousel || !leftBtn || !rightBtn || !noResultsMsg) return;

        const updateButtonState = () => {
            const scrollLeft = carousel.scrollLeft;
            const clientWidth = carousel.clientWidth;
            const scrollWidth = carousel.scrollWidth;

            leftBtn.disabled = scrollLeft <= 0;
            rightBtn.disabled = Math.round(scrollLeft) + clientWidth >= scrollWidth - 1;
        };

        const visibleCards = Array.from(carousel.children).filter(card => window.getComputedStyle(card).display !== 'none');
        const hasScrollableContent = carousel.scrollWidth > carousel.clientWidth;

        if (hasScrollableContent) {
            leftBtn.style.display = 'flex';
            rightBtn.style.display = 'flex';
            noResultsMsg.style.display = 'none';
        } else {
            leftBtn.style.display = 'none';
            rightBtn.style.display = 'none';
            if (visibleCards.length === 0) {
                 noResultsMsg.style.display = 'block';
            } else {
                noResultsMsg.style.display = 'none';
            }
        }

        let isDown = false;
        let startX;
        let scrollLeftPos;

        updateButtonState();
        carousel.addEventListener('scroll', updateButtonState);

        carousel.addEventListener('mousedown', (e) => {
            isDown = true;
            carousel.classList.add('active');
            startX = e.pageX - carousel.offsetLeft;
            scrollLeftPos = carousel.scrollLeft;
        });

        carousel.addEventListener('mouseleave', () => {
            isDown = false;
            carousel.classList.remove('active');
        });

        carousel.addEventListener('mouseup', () => {
            isDown = false;
            carousel.classList.remove('active');
        });

        carousel.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - carousel.offsetLeft;
            const walk = (x - startX) * 1;
            carousel.scrollLeft = scrollLeftPos - walk;
        });
    }

    // 카드 필터링
    function filterCards(sectionId, typeFilter, regionFilter = '') {
        const cards = (sectionId === 'popular') ? popularCards : eventCards;

        cards.forEach(card => {
            const cardType = card.dataset.type;
            const cardRegion = card.dataset.region;

            const typeMatch = (typeFilter === 'all' || cardType === typeFilter);
            const regionMatch = !regionFilter || (cardRegion && cardRegion.includes(regionFilter));

            if (typeMatch && regionMatch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        setupCarousel(sectionId);
    }

    // 카드 클릭 이벤트 - 각 카테고리별 상세 페이지로 이동
    function addCardClickEvents() {
        // 인기 여행지 카드 클릭 이벤트
        document.querySelectorAll('#popular-carousel .card').forEach(card => {
            card.addEventListener('click', () => {
                const cardType = card.dataset.type;
                const cardTitle = card.querySelector('.card-title').textContent;

                // 카테고리별로 다른 페이지로 이동
                switch(cardType) {
                    case '숙박':
                        window.location.href = '/kakaoResult4'; // 숙박 목록 페이지
                        break;
                    case '관광지':
                        window.location.href = '/map'; // 지도 페이지
                        break;
                    case '레저':
                    case '음식점':
                    case '쇼핑':
                        // 각각의 API 엔드포인트로 이동하거나 통합 검색 결과 페이지로
                        window.location.href = `/search?category=${cardType}&query=${cardTitle}`;
                        break;
                    default:
                        window.location.href = '/map';
                }
            });
        });

        // 이벤트 카드 클릭 이벤트
        document.querySelectorAll('#event-carousel .event-card').forEach(card => {
            card.addEventListener('click', () => {
                const cardType = card.dataset.type;
                const cardTitle = card.querySelector('h3').textContent;

                switch(cardType) {
                    case '숙박':
                        window.location.href = '/kakaoResult4';
                        break;
                    case '관광지':
                        window.location.href = '/map';
                        break;
                    case '레저':
                    case '음식점':
                    case '쇼핑':
                        window.location.href = `/search?category=${cardType}&query=${cardTitle}`;
                        break;
                    default:
                        window.location.href = '/map';
                }
            });
        });
    }

    // 모든 드롭다운 닫는 공통 함수
    // --- 전역 변수 설정 ---
    let datePickerBtn = document.getElementById('date-picker-btn');
    let datePickerDropdown = document.getElementById('date-picker-dropdown');
    let dateTextSpan = document.getElementById('date-text');
    let peoplePickerBtn = document.getElementById('people-picker-btn');
    let peoplePickerDropdown = document.getElementById('people-picker-dropdown');
    let peopleTextSpan = document.getElementById('people-text');
    let peopleOptionBtns = document.querySelectorAll('#people-picker-dropdown .people-options button');
    let peopleInput = document.getElementById('people-input');
    let searchInput = document.getElementById('search-input');
    let searchDropdown = document.getElementById('search-dropdown');
    let popularCarousel = document.getElementById('popular-carousel');
    let eventCarousel = document.getElementById('event-carousel');
    let popularNoResults = document.getElementById('popular-no-results');
    let eventNoResults = document.getElementById('event-no-results');

    // 햄버거 메뉴 관련 변수 추가
    const hamburgerBtn = document.getElementById('hamburger-menu');
    const hamburgerDropdown = document.getElementById('hamburger-dropdown');

    // 캐러셀 관련 변수
    const popularCards = document.querySelectorAll('#popular-carousel .card');
    const eventCards = document.querySelectorAll('#event-carousel .event-card');

    // 달력 관련 변수
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn2 = document.getElementById('next-month-btn-2');

    let currentDate = new Date();
    let startDate = null;
    let endDate = null;
    let holidays = {};

    const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];

    // --- 기능 함수 ---
    // 공휴일 데이터 불러오기
    async function fetchHolidays(year) {
        try {
            // 간단한 공휴일 데이터 (실제로는 API에서 가져올 수 있음)
            holidays = {};
            renderCalendars();
        } catch (error) {
            console.error('공휴일 데이터 로드 실패:', error);
        }
    }

    function isHoliday(date) {
        const dateStr = date.toISOString().split('T')[0];
        return holidays[dateStr] || '';
    }

    // 날짜 텍스트 업데이트
    function updateDateText() {
        if (startDate && endDate) {
            const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const nights = diffDays > 0 ? diffDays : 0;

            const startMonth = (startDate.getMonth() + 1).toString().padStart(2, '0');
            const startDay = startDate.getDate().toString().padStart(2, '0');
            const startDayName = daysOfWeek[startDate.getDay()];

            const endMonth = (endDate.getMonth() + 1).toString().padStart(2, '0');
            const endDay = endDate.getDate().toString().padStart(2, '0');
            const endDayName = daysOfWeek[endDate.getDay()];

            dateTextSpan.textContent = `${startMonth}.${startDay} ${startDayName} - ${endMonth}.${endDay} ${endDayName} (${nights}박)`;
        } else if (startDate) {
            const startMonth = (startDate.getMonth() + 1).toString().padStart(2, '0');
            const startDay = startDate.getDate().toString().padStart(2, '0');
            const startDayName = daysOfWeek[startDate.getDay()];
            dateTextSpan.textContent = `${startMonth}.${startDay} ${startDayName}`;
        } else {
            dateTextSpan.textContent = '날짜';
        }
    }

    // 달력 그리기
    function renderMonth(monthOffset, calendarGridId, calendarTitleId) {
        const monthDate = new Date(currentDate);
        monthDate.setMonth(currentDate.getMonth() + monthOffset);

        const calendarGrid = document.getElementById(calendarGridId);
        const calendarTitle = document.getElementById(calendarTitleId);

        calendarGrid.innerHTML = '';

        daysOfWeek.forEach(day => {
            const header = document.createElement('div');
            header.className = 'day-header';
            header.textContent = day;
            if (day === '일') header.style.color = 'red';
            else if (day === '토') header.style.color = 'blue';
            calendarGrid.appendChild(header);
        });

        const year = monthDate.getFullYear();
        const month = monthDate.getMonth();
        calendarTitle.textContent = `${year}년 ${month + 1}월`;

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyDay = document.createElement('div');
            calendarGrid.appendChild(emptyDay);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = i;

            const dayDate = new Date(year, month, i);
            dayDate.setHours(0, 0, 0, 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (dayDate < today) {
                dayDiv.classList.add('inactive');
            } else {
                dayDiv.dataset.date = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                dayDiv.addEventListener('click', handleDateClick);
            }

            if (dayDate.getDay() === 0) {
                dayDiv.classList.add('sunday');
            } else if (dayDate.getDay() === 6) {
                dayDiv.classList.add('saturday');
            }

            const holidayName = isHoliday(dayDate);
            if (holidayName) {
                dayDiv.classList.add('holiday');
                dayDiv.title = holidayName;
            }

            if (startDate && dayDate.getTime() === startDate.getTime()) {
                dayDiv.classList.add('start-date');
            }
            if (endDate && dayDate.getTime() === endDate.getTime()) {
                dayDiv.classList.add('end-date');
            }
            if (startDate && endDate && dayDate > startDate && dayDate < endDate) {
                dayDiv.classList.add('in-range');
            }

            calendarGrid.appendChild(dayDiv);
        }
    }

    function renderCalendars() {
        renderMonth(0, 'calendar-grid-1', 'calendar-title-1');
        renderMonth(1, 'calendar-grid-2', 'calendar-title-2');

        const today = new Date();
        prevMonthBtn.style.visibility = (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() === today.getMonth()) ? 'hidden' : 'visible';
    }

    // 날짜 선택 이벤트 핸들러
    function handleDateClick(e) {
        e.stopPropagation();

        if (e.target.classList.contains('inactive')) {
            return;
        }

        const [year, month, day] = e.target.dataset.date.split('-').map(Number);
        const selectedDate = new Date(year, month - 1, day);
        selectedDate.setHours(0, 0, 0, 0);

        if (!startDate || (startDate && endDate)) {
            startDate = selectedDate;
            endDate = null;
        } else {
            if (selectedDate.getTime() < startDate.getTime()) {
                endDate = startDate;
                startDate = selectedDate;
            } else {
                endDate = selectedDate;
            }
            updateDateText();
            datePickerDropdown.style.display = 'none';
        }
        renderCalendars();
    }

    // 캐러셀 스크롤 함수
    function scrollCarousel(id, direction) {
        const carousel = document.getElementById(id + '-carousel');
        const scrollAmount = carousel.clientWidth;
        carousel.scrollBy({
            left: scrollAmount * direction,
            behavior: 'smooth'
        });
    }

    // 화살표 버튼 활성화/비활성화 및 드래그 스크롤링 관리
    function setupCarousel(id) {
        const carousel = document.getElementById(id + '-carousel');
        const leftBtn = document.getElementById(id + '-left-btn');
        const rightBtn = document.getElementById(id + '-right-btn');
        const noResultsMsg = document.getElementById(id + '-no-results');

        if (!carousel || !leftBtn || !rightBtn || !noResultsMsg) return;

        const updateButtonState = () => {
            const scrollLeft = carousel.scrollLeft;
            const clientWidth = carousel.clientWidth;
            const scrollWidth = carousel.scrollWidth;

            leftBtn.disabled = scrollLeft <= 0;
            rightBtn.disabled = Math.round(scrollLeft) + clientWidth >= scrollWidth - 1;
        };

        const visibleCards = Array.from(carousel.children).filter(card => window.getComputedStyle(card).display !== 'none');
        const hasScrollableContent = carousel.scrollWidth > carousel.clientWidth;

        if (hasScrollableContent) {
            leftBtn.style.display = 'flex';
            rightBtn.style.display = 'flex';
            noResultsMsg.style.display = 'none';
        } else {
            leftBtn.style.display = 'none';
            rightBtn.style.display = 'none';
            if (visibleCards.length === 0) {
                 noResultsMsg.style.display = 'block';
            } else {
                noResultsMsg.style.display = 'none';
            }
        }

        let isDown = false;
        let startX;
        let scrollLeftPos;

        updateButtonState();
        carousel.addEventListener('scroll', updateButtonState);

        carousel.addEventListener('mousedown', (e) => {
            isDown = true;
            carousel.classList.add('active');
            startX = e.pageX - carousel.offsetLeft;
            scrollLeftPos = carousel.scrollLeft;
        });

        carousel.addEventListener('mouseleave', () => {
            isDown = false;
            carousel.classList.remove('active');
        });

        carousel.addEventListener('mouseup', () => {
            isDown = false;
            carousel.classList.remove('active');
        });

        carousel.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - carousel.offsetLeft;
            const walk = (x - startX) * 1;
            carousel.scrollLeft = scrollLeftPos - walk;
        });
    }

    // 카드 필터링
    function filterCards(sectionId, typeFilter, regionFilter = '') {
        const cards = (sectionId === 'popular') ? popularCards : eventCards;

        cards.forEach(card => {
            const cardType = card.dataset.type;
            const cardRegion = card.dataset.region;

            const typeMatch = (typeFilter === 'all' || cardType === typeFilter);
            const regionMatch = !regionFilter || (cardRegion && cardRegion.includes(regionFilter));

            if (typeMatch && regionMatch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        setupCarousel(sectionId);
    }

    // 카드 클릭 이벤트 - 각 카테고리별 상세 페이지로 이동
    function addCardClickEvents() {
        // 인기 여행지 카드 클릭 이벤트
        document.querySelectorAll('#popular-carousel .card').forEach(card => {
            card.addEventListener('click', () => {
                const cardType = card.dataset.type;
                const cardTitle = card.querySelector('.card-title').textContent;

                // 카테고리별로 다른 페이지로 이동
                switch(cardType) {
                    case '숙박':
                        window.location.href = '/kakaoResult4'; // 숙박 목록 페이지
                        break;
                    case '관광지':
                        window.location.href = '/map'; // 지도 페이지
                        break;
                    case '레저':
                    case '음식점':
                    case '쇼핑':
                        // 각각의 API 엔드포인트로 이동하거나 통합 검색 결과 페이지로
                        window.location.href = `/search?category=${cardType}&query=${cardTitle}`;
                        break;
                    default:
                        window.location.href = '/map';
                }
            });
        });

        // 이벤트 카드 클릭 이벤트
        document.querySelectorAll('#event-carousel .event-card').forEach(card => {
            card.addEventListener('click', () => {
                const cardType = card.dataset.type;
                const cardTitle = card.querySelector('h3').textContent;

                switch(cardType) {
                    case '숙박':
                        window.location.href = '/kakaoResult4';
                        break;
                    case '관광지':
                        window.location.href = '/map';
                        break;
                    case '레저':
                    case '음식점':
                    case '쇼핑':
                        window.location.href = `/search?category=${cardType}&query=${cardTitle}`;
                        break;
                    default:
                        window.location.href = '/map';
                }
            });
        });
    }

    // 모든 드롭다운 닫는 공통 함수
    function closeAllDropdowns() {
        if (datePickerDropdown) {
            datePickerDropdown.style.display = 'none';
        }
        if (peoplePickerDropdown) {
            peoplePickerDropdown.style.display = 'none';
        }
        if (searchDropdown) {
            searchDropdown.style.display = 'none';
        }
        if (hamburgerDropdown) {
            hamburgerDropdown.classList.remove('open');
        }
    }

    // --- 이벤트 리스너 ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchHolidays(new Date().getFullYear());
        fetchHolidays(new Date().getFullYear() + 1);

        filterCards('popular', 'all', '');
        filterCards('event', 'all', '');

        // 초기 달력 렌더링
        renderCalendars();

        // 카드 클릭 이벤트 추가
        addCardClickEvents();
    });

    // 햄버거 메뉴 클릭 이벤트
    if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isCurrentlyOpen = hamburgerDropdown.classList.contains('open');
            closeAllDropdowns();
            if (!isCurrentlyOpen) {
                hamburgerDropdown.classList.add('open');
            }
        });
    }

    // 날짜/인원 버튼 클릭 이벤트
    if (datePickerBtn) {
        datePickerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isCurrentlyOpen = datePickerDropdown.style.display === 'block';
            closeAllDropdowns();
            if (!isCurrentlyOpen) {
                datePickerDropdown.style.display = 'block';
                renderCalendars();
            }
        });
    }

    if (peoplePickerBtn) {
        peoplePickerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isCurrentlyOpen = peoplePickerDropdown.style.display === 'block';
            closeAllDropdowns();
            if (!isCurrentlyOpen) {
                peoplePickerDropdown.style.display = 'block';
            }
        });
    }

    // 인원 옵션 버튼 클릭 이벤트
    peopleOptionBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            peopleOptionBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            peopleInput.value = '';
            peopleTextSpan.textContent = `${btn.dataset.value}인`;
            peoplePickerDropdown.style.display = 'none';
        });
    });

    // 인원 직접 입력 변경 이벤트
    if (peopleInput) {
        peopleInput.addEventListener('input', (e) => {
            peopleOptionBtns.forEach(b => b.classList.remove('active'));
            const value = e.target.value;
            if (value) {
                peopleTextSpan.textContent = `${value}인`;
            } else {
                peopleTextSpan.textContent = '인원';
            }
        });

        peopleInput.addEventListener('blur', () => {
            if (peopleInput.value) {
                peoplePickerDropdown.style.display = 'none';
            }
        });
    }

    // 검색창 포커스 시 드롭다운 메뉴 토글
    if (searchInput) {
        searchInput.addEventListener('focus', () => {
            closeAllDropdowns();
            searchDropdown.style.display = 'block';
        });

        searchInput.addEventListener('blur', (e) => {
            if (!e.relatedTarget || !searchDropdown.contains(e.relatedTarget)) {
                searchDropdown.style.display = 'none';
            }
        });
    }

    // 드롭다운 아이템 클릭 시 검색창에 내용 채우기
    if (searchDropdown) {
        searchDropdown.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('search-dropdown-item')) {
                searchInput.value = e.target.textContent;
                searchDropdown.style.display = 'none';
                document.getElementById('search-button').click();
            }
        });
    }

    // 드롭다운 외부 클릭 시 닫기
    window.addEventListener('click', (e) => {
        if (!datePickerDropdown.contains(e.target) && !datePickerBtn.contains(e.target) &&
            !peoplePickerDropdown.contains(e.target) && !peoplePickerBtn.contains(e.target) &&
            !searchDropdown.contains(e.target) && !searchInput.contains(e.target) &&
            !hamburgerDropdown.contains(e.target) && !hamburgerBtn.contains(e.target)) {
            closeAllDropdowns();
        }
    });

    // 이벤트 섹션 탭 버튼 클릭 이벤트
    document.querySelectorAll('.events-section .search-tabs button').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll('.events-section .search-tabs button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            const type = e.target.dataset.filter;
            const region = document.getElementById('search-input').value.trim();

            filterCards('event', type, region);
        });
    });

// 검색 버튼 클릭 이벤트 수정
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.querySelector('form[action*="kakaoResult4"]');
    const searchInput = searchForm.querySelector('input[name="keyword"]');

    // form 기본 submit 이벤트 사용
    searchForm.addEventListener('submit', function(e) {
        const keyword = searchInput.value.trim();
        if (!keyword) {
            e.preventDefault();
            alert('검색어를 입력해주세요.');
            return false;
        }
        // form이 자동으로 GET 요청을 보냄
    });
});

    // 엔터 키 입력 시 검색
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('search-button').click();
        }
    });

    // 달력 월 이동 버튼 이벤트
    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendars();
        });
    }

    if (nextMonthBtn2) {
        nextMonthBtn2.addEventListener('click', (e) => {
            e.stopPropagation();
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendars();
        });
    }

    // 사이드 메뉴 섹션 토글
    document.querySelectorAll('.side-menu-section').forEach(section => {
        const title = section.querySelector('.side-menu-section-title');
        if(title) {
            title.addEventListener('click', () => {
                section.classList.toggle('closed');
            });
        }
    });

    // 시/군/구 목록 데이터 (예시)
    const sggList = [
        '강남구', '강동구', '강북구', '강서구', '관악구', '광진구', '구로구', '금천구', '노원구', '도봉구', '동대문구',
        '동작구', '마포구', '서대문구', '서초구', '성동구', '성북구', '송파구', '양천구', '영등포구', '용산구', '은평구',
        '종로구', '중구', '중랑구', '동구', '서구', '부산진구', '해운대구', '영도구', '수성구', '달서구', '연수구', '미추홀구'
    ];

    // 지역별 서브 리스트 동적 생성 및 사이드 메뉴 카테고리 매핑

    // 지역별 서브 리스트 동적 생성
    const regionSubList = document.getElementById('region-sub-list');
    if (regionSubList) {
        sggList.forEach(sgg => {
            const li = document.createElement('li');
            li.textContent = sgg;
            li.addEventListener('click', (e) => {
                e.stopPropagation();
                alert(`${sgg} 검색 화면으로 이동`);
            });
            regionSubList.appendChild(li);
        });
    }

    // 카테고리 버튼 이벤트 리스너 추가 (사이드 메뉴용)
    document.querySelectorAll('.side-menu-grid button[data-category]').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const category = e.target.dataset.category;
            alert(`${category} 상품 검색 화면으로 이동`);
        });
    });

    <div th:replace="fragments/header :: scripts"></div>
</script>
</body>
</html>