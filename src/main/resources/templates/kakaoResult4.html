<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Tour</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <th:block th:insert="~{fragments/header :: styles}"></th:block>
    <style>
        body { margin:0; font-family: Arial, sans-serif; }
        header { display:flex; align-items:center; justify-content:space-between; padding:15px 30px; border-bottom:1px solid #eee; }
        header h1 { font-size:24px; font-weight:bold; }
        .search-box { flex:1; margin:0 20px; }
        .search-box input { width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:5px; }
        .auth-btn { border:1px solid #ccc; padding:6px 12px; border-radius:5px; background:#fff; cursor:pointer; }
        .container { display:flex; padding:30px; width: 1200px; margin: 0 auto;}
        .filter { width:200px; background:#f7f7f7; padding:20px; border-radius:8px; }
        .filter h3 { font-size:16px; margin-bottom:10px; }
        .filter label { display:block; margin:8px 0; cursor:pointer; }
        .content { flex:1; margin-left:20px; }
        .map { width:100%; height:460px; margin-bottom:20px; border-radius:12px; border:1px solid #eee; box-shadow:0 1px 2px rgba(0,0,0,.03); background:#fafafa; }
        .item { display:flex; align-items:center; border-bottom:1px solid #eee; padding:15px 0; cursor:pointer; transition: background-color 0.2s; }
        .item:hover { background-color: #f8f9fa; }
        .item-img { width:150px; height:100px; background:#f0f0f0; margin-right:15px; object-fit:cover; border-radius:8px; }
        .item-info { flex:1; }
        .item-info h4 { margin:5px 0; font-size:18px; }
        .item-info p { margin:2px 0; font-size:14px; color:#555; }
        .pagination { display:flex; justify-content:center; margin:20px 0; gap:5px; }
        .pagination button { border:1px solid #ccc; background:#fff; padding:6px 10px; border-radius:5px; cursor:pointer; }
        .pagination button.active { background:#333; color:#fff; font-weight:bold; }
        .pagination button:disabled { opacity:0.4; cursor:default; }
        .no-results { font-size:16px; color:#666; margin:20px 0; text-align: center; padding: 40px; }
        #debug { margin-top:10px; font-size:13px; color:#d00; white-space:pre-wrap; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { color: #d00; padding: 20px; background: #fee; border-radius: 8px; margin: 20px 0; }
    </style>
    <!-- kakaoResult4.htmlì˜ ìˆ˜ì •ëœ JavaScript ë¶€ë¶„ -->
    <script th:inline="javascript">
        const KAKAO_JS_KEY = "c1a0fc126750fc75623bdc1df69dfb93";

        // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const places = /*[[${accommodations}]]*/ [];
        const serverCurrentPage = /*[[${currentPage}]]*/ 0;
        const serverTotalPages = /*[[${totalPages}]]*/ 0;
        const serverKeyword = /*[[${keyword}]]*/ '';

        let map, markers = [];
        let currentPage = 1;
        const itemsPerPage = 5;

        const CATEGORY_MAP = {
            'ì „ì²´': ['B02','A03','A01','A04','A05'],
            'ìˆ™ë°•': ['B02'],
            'ë ˆì €': ['A03'],
            'ê´€ê´‘ì§€': ['A01'],
            'ì‡¼í•‘': ['A04'],
            'ìŒì‹ì ': ['A05']
        };

        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                keyword: urlParams.get('keyword') || '',
                page: parseInt(urlParams.get('page')) || 0,
                region: urlParams.get('region') || '',
                category: urlParams.get('category') || ''
            };
        }

        function setInitialSearchAndTitle() {
            const params = getUrlParams();
            const searchInput = document.querySelector('.search-box input');
            const pageTitle = document.getElementById('page-title');

            if (searchInput) {
                // ì„œë²„ì—ì„œ ì „ë‹¬ëœ í‚¤ì›Œë“œ ë˜ëŠ” URL íŒŒë¼ë¯¸í„° ì‚¬ìš©
                const keyword = serverKeyword || params.keyword;
                if (keyword) {
                    searchInput.value = keyword;
                }
            }

            if (pageTitle) {
                const keyword = serverKeyword || params.keyword;
                const titleText = keyword ? `'${keyword}' ì—¬í–‰ ì •ë³´` : 'ì „êµ­ ì—¬í–‰ ì •ë³´';
                pageTitle.textContent = titleText;
            }
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ì„ ì„œë²„ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë Œë”ë§
        function renderServerPagination() {
            const container = document.querySelector('.pagination');
            if (!container) return;

            container.innerHTML = "";

            if (serverTotalPages <= 1) return;

            const params = getUrlParams();
            const keyword = serverKeyword || params.keyword || '';

            const makeBtn = (text, page, disabled = false, active = false) => {
                const btn = document.createElement("button");
                btn.textContent = text;
                if (disabled) btn.disabled = true;
                if (active) btn.classList.add("active");
                btn.addEventListener("click", () => {
                    if (!disabled) {
                        const url = new URL(window.location);
                        url.searchParams.set('page', page);
                        if (keyword) {
                            url.searchParams.set('keyword', keyword);
                        }
                        window.location.href = url.toString();
                    }
                });
                return btn;
            };

            // ì´ì „ í˜ì´ì§€
            container.appendChild(makeBtn("â‰ª", 0, serverCurrentPage === 0));
            container.appendChild(makeBtn("â€¹", serverCurrentPage - 1, serverCurrentPage === 0));

            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const maxVisible = 5;
            let start = Math.max(0, serverCurrentPage - Math.floor(maxVisible / 2));
            let end = Math.min(serverTotalPages - 1, start + maxVisible - 1);

            if (end - start + 1 < maxVisible) {
                start = Math.max(0, end - maxVisible + 1);
            }

            if (start > 0) {
                container.appendChild(makeBtn("1", 0));
                if (start > 1) {
                    const dots = document.createElement("span");
                    dots.textContent = "...";
                    dots.style.margin = "0 5px";
                    container.appendChild(dots);
                }
            }

            for (let i = start; i <= end; i++) {
                container.appendChild(makeBtn((i + 1).toString(), i, false, i === serverCurrentPage));
            }

            if (end < serverTotalPages - 1) {
                if (end < serverTotalPages - 2) {
                    const dots = document.createElement("span");
                    dots.textContent = "...";
                    dots.style.margin = "0 5px";
                    container.appendChild(dots);
                }
                container.appendChild(makeBtn(serverTotalPages.toString(), serverTotalPages - 1));
            }

            // ë‹¤ìŒ í˜ì´ì§€
            container.appendChild(makeBtn("â€º", serverCurrentPage + 1, serverCurrentPage === serverTotalPages - 1));
            container.appendChild(makeBtn("â‰«", serverTotalPages - 1, serverCurrentPage === serverTotalPages - 1));
        }

        async function initializeApp() {
            try {
                showLoading();
                setInitialSearchAndTitle();
                await loadKakaoSDK();

                const mapContainer = document.getElementById('map');
                const center = new kakao.maps.LatLng(36.5, 127.8);
                map = new kakao.maps.Map(mapContainer, { center, level: 13 });

                hideLoading();
                setupEventListeners();

                // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ ì§€ë„ì™€ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                renderMarkers(places);
                renderList(places);
                renderServerPagination(); // ì„œë²„ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜
                adjustMapToResults(places);

            } catch (error) {
                showError(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
            }
        }

        function setupEventListeners() {
            const searchInput = document.querySelector('.search-box input');
            if (searchInput) {
                // ê²€ìƒ‰ ì‹œ ì„œë²„ë¡œ ì´ë™
                searchInput.addEventListener('keydown', e => {
                    if(e.key === 'Enter') {
                        e.preventDefault();
                        const keyword = searchInput.value.trim();
                        const url = new URL(window.location);
                        if (keyword) {
                            url.searchParams.set('keyword', keyword);
                        } else {
                            url.searchParams.delete('keyword');
                        }
                        url.searchParams.set('page', '0'); // ì²« í˜ì´ì§€ë¡œ ë¦¬ì…‹
                        window.location.href = url.toString();
                    }
                });
            }

            // ì¹´í…Œê³ ë¦¬ í•„í„°ëŠ” í´ë¼ì´ì–¸íŠ¸ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬
            document.querySelectorAll('.filter input[type=checkbox]').forEach(cb => {
                cb.addEventListener('change', () => {
                    const allBox = document.querySelector('.filter input[data-cat="ì „ì²´"]');
                    const otherBoxes = Array.from(document.querySelectorAll('.filter input[type=checkbox]')).filter(b => b.dataset.cat !== 'ì „ì²´');

                    if(cb.dataset.cat === 'ì „ì²´'){
                        otherBoxes.forEach(b => b.checked = cb.checked);
                    } else {
                        if(otherBoxes.every(b => !b.checked)) {
                            allBox.checked = true;
                        } else {
                            allBox.checked = false;
                        }
                    }
                    applyClientSideFilter();
                });
            });
        }

        // í´ë¼ì´ì–¸íŠ¸ì‚¬ì´ë“œ ì¹´í…Œê³ ë¦¬ í•„í„°ë§ (í˜ì´ì§€ë„¤ì´ì…˜ ì—†ì´)
        function applyClientSideFilter() {
            const checkedBoxes = Array.from(document.querySelectorAll('.filter input[type=checkbox]:checked'));
            let selectedCats = new Set();
            checkedBoxes.forEach(cb => {
                const cats = CATEGORY_MAP[cb.dataset.cat];
                if (cats) cats.forEach(c => selectedCats.add(c));
            });

            if (selectedCats.size === 0) {
                Object.values(CATEGORY_MAP).forEach(arr => arr.forEach(c => selectedCats.add(c)));
            }

            const filtered = places.filter(place =>
                selectedCats.has(place.cat1) ||
                selectedCats.has(place.cat2) ||
                selectedCats.has(place.cat3)
            );

            renderMarkers(filtered);
            renderList(filtered);
            adjustMapToResults(filtered);

            // í•„í„°ë§ ì‹œì—ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¹€
            const pagination = document.querySelector('.pagination');
            if (pagination) {
                pagination.style.display = filtered.length === places.length ? 'flex' : 'none';
            }
        }

        // ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼...
        function renderMarkers(data) {
            markers.forEach(m => m.setMap(null));
            markers = [];
            if (!Array.isArray(data) || !map) return;
            data.forEach(place => {
                const lat = Number(place.mapy);
                const lng = Number(place.mapx);
                if (!lat || !lng) return;
                const pos = new kakao.maps.LatLng(lat, lng);
                const marker = new kakao.maps.Marker({
                    map,
                    position: pos,
                    title: place.title || ""
                });
                marker.setClickable(true);
                kakao.maps.event.addListener(marker, 'click', function() {
                    handleItemClick(place);
                });
                markers.push(marker);
            });
        }

        function renderList(data) {
            const content = document.querySelector('.content');
            content.querySelectorAll('.item, .no-results').forEach(el => el.remove());
            if (!Array.isArray(data) || data.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.innerHTML = '<h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3><p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>';
                content.appendChild(noResults);
                return;
            }
            data.forEach(place => {
                const div = document.createElement('div');
                div.className = 'item';
                const img = place.firstimage || 'https://via.placeholder.com/150x100?text=ì´ë¯¸ì§€+ì—†ìŒ';
                div.innerHTML = `
                    <img class="item-img" src="${img}" alt="${escapeHtml(place.title||'')}" onerror="this.src='https://via.placeholder.com/150x100?text=ì´ë¯¸ì§€+ì—†ìŒ'">
                    <div class="item-info">
                        <h4>${escapeHtml(place.title||'ë¬´ëª…')}</h4>
                        <p>ğŸ“ ${escapeHtml(getFullAddress(place))}</p>
                        <p>ğŸ·ï¸ ${escapeHtml(getCategoryText(place))}</p>
                    </div>
                `;
                div.addEventListener('click', () => handleItemClick(place));
                content.appendChild(div);
            });
        }

        function adjustMapToResults(data) {
            if (!data || data.length === 0 || !map) return;
            const bounds = new kakao.maps.LatLngBounds();
            let hasValidCoords = false;
            data.forEach(place => {
                const lat = Number(place.mapy);
                const lng = Number(place.mapx);
                if (lat && lng) {
                    bounds.extend(new kakao.maps.LatLng(lat, lng));
                    hasValidCoords = true;
                }
            });
            if (hasValidCoords) {
                map.setBounds(bounds);
            }
        }

        // ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤...
        function getFullAddress(place) {
            const parts = [place.addr1, place.addr2, place.addr3].filter(Boolean);
            return parts.length > 0 ? parts.join(' ') : 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
        }

        function getCategoryText(place) {
            const cats = [place.cat1, place.cat2, place.cat3].filter(Boolean);
            return cats.length > 0 ? cats.join(' > ') : 'ì¹´í…Œê³ ë¦¬ ë¯¸ë¶„ë¥˜';
        }

        function handleItemClick(place) {
            const urlMap = {
                'B02': `/accommodation/view/${place.id}`,
                'A03': `/leports/view/${place.id}`,
                'A01': `/touristSpot/view/${place.id}`,
                'A04': `/shopping/view/${place.id}`,
                'A05': `/restaurant/view/${place.id}`
            };
            if(place.cat1 && urlMap[place.cat1]){
                window.location.href = urlMap[place.cat1];
            } else {
                alert(`ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\\nì¹´í…Œê³ ë¦¬: ${place.cat1 || 'ë¯¸ë¶„ë¥˜'}`);
            }
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, s => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[s]));
        }

        function showLoading() {
            const content = document.querySelector('.content');
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.id = 'loading';
            loading.innerHTML = '<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            content.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.remove();
        }

        function showError(message) {
            hideLoading();
            const content = document.querySelector('.content');
            const error = document.createElement('div');
            error.className = 'error';
            error.innerHTML = `<h3>ì˜¤ë¥˜ ë°œìƒ</h3><p>${message}</p>`;
            content.appendChild(error);
            console.error('Error:', message);
        }

        async function loadKakaoSDK() {
            return new Promise((resolve, reject) => {
                if (window.kakao && window.kakao.maps) {
                    resolve();
                    return;
                }
                const src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${encodeURIComponent(KAKAO_JS_KEY)}&autoload=false&libraries=services`;
                const script = document.createElement("script");
                script.src = src;
                script.defer = true;
                script.onload = () => {
                    if (window.kakao && window.kakao.maps) {
                        kakao.maps.load(() => resolve());
                    } else {
                        reject(new Error('Kakao Maps API ë¡œë“œ ì‹¤íŒ¨'));
                    }
                };
                script.onerror = () => reject(new Error('Kakao SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                document.head.appendChild(script);
            });
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</head>
<body>

<div th:replace="fragments/header :: header"></div>

<main class="container">
    <aside class="filter">
        <h3>í•„í„°</h3>
        <label><input type="checkbox" checked data-cat="ì „ì²´">ì „ì²´</label>
        <label><input type="checkbox" data-cat="ìˆ™ë°•">ìˆ™ë°•</label>
        <label><input type="checkbox" data-cat="ë ˆì €">ë ˆì €</label>
        <label><input type="checkbox" data-cat="ê´€ê´‘ì§€">ê´€ê´‘ì§€</label>
        <label><input type="checkbox" data-cat="ì‡¼í•‘">ì‡¼í•‘</label>
        <label><input type="checkbox" data-cat="ìŒì‹ì ">ìŒì‹ì </label>
    </aside>

    <section class="content">
        <h2 id="page-title"></h2>
        <div id="map" class="map"></div>
        <div class="pagination" id="pagination"></div>
    </section>
</main>

<div id="debug"></div>
</body>
</html>